<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="My Routine">
<title>My Routine</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F5F1EB;--card:#FFFFFF;--pri:#2C4B2F;--acc:#C8963E;
  --txt:#1A2A1C;--mid:#556655;--soft:#8A9E8C;--div:#E2DAD0;
  --donebg:#EBF5EC;--donebd:#A8D5AB;--donec:#2E7D32;
  --gym1:#1B5E20;--gym2:#0A3311;--rest1:#37474F;--rest2:#1C2B30;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--txt);min-height:100dvh;overflow-x:hidden}

/* BOTTOM NAV */
.nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1.5px solid var(â€“div);display:flex;z-index:99;padding-bottom:env(safe-area-inset-bottom,0px)}
.nv{flex:1;padding:10px 4px 9px;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;border:none;background:none;font-family:â€˜Nunitoâ€™,sans-serif;color:var(â€“soft);font-size:10.5px;font-weight:700;transition:color .2s}
.nv.on{color:var(â€“pri)}
.nv .ni{font-size:22px;line-height:1.2}

/* VIEWS */
.view{display:none;padding-bottom:80px}
.view.on{display:block}

/* HEADER */
.hdr{padding:calc(env(safe-area-inset-top,0px) + 12px) 15px 0;background:var(â€“bg);position:sticky;top:0;z-index:90}
.hdr-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.logo{font-family:â€˜Loraâ€™,serif;font-size:20px;font-weight:700;color:var(â€“pri)}
.ib{width:34px;height:34px;border-radius:50%;border:none;background:#ece8e0;color:#444;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}

/* BANNER */
.banner{border-radius:14px;padding:16px 15px 13px;margin-bottom:11px;color:#fff;position:relative;overflow:hidden}
.banner.gym{background:linear-gradient(135deg,var(â€“gym1),var(â€“gym2))}
.banner.rest{background:linear-gradient(135deg,var(â€“rest1),var(â€“rest2))}
.banner::before{content:â€™â€™;position:absolute;right:-20px;top:-20px;width:95px;height:95px;border-radius:50%;background:rgba(255,255,255,.06);pointer-events:none}
.brow1{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.dayname{font-family:â€˜Loraâ€™,serif;font-size:30px;font-weight:700;line-height:1.1}
.badge{display:inline-block;background:rgba(255,255,255,.18);padding:3px 10px;border-radius:20px;font-size:10.5px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;margin-top:5px}
.breset{background:rgba(255,255,255,.17);border:none;color:#fff;border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:17px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.brow2{margin-top:9px;display:flex;align-items:center;gap:7px}
.stagepill{background:rgba(255,255,255,.16);padding:2px 9px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;flex-shrink:0}
.pbar-wrap{flex:1;background:rgba(255,255,255,.2);border-radius:6px;height:4px;overflow:hidden;min-width:0}
.pbar-fill{height:100%;background:rgba(255,255,255,.85);border-radius:6px;transition:width .5s}
.pbar-lbl{font-size:10.5px;opacity:.7;white-space:nowrap;flex-shrink:0}
.brow3{margin-top:6px;display:flex;align-items:center;gap:7px}
.dbar-wrap{flex:1;background:rgba(255,255,255,.14);border-radius:6px;height:3px;overflow:hidden;min-width:0}
.dbar-fill{height:100%;background:rgba(255,255,255,.75);border-radius:6px;transition:width .4s}
.dbar-lbl{font-size:10.5px;opacity:.6;white-space:nowrap;flex-shrink:0}

/* TABS */
.tabs{display:flex;gap:5px;overflow-x:auto;padding-bottom:10px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}
.tab{flex-shrink:0;padding:6px 12px;border-radius:20px;border:1.5px solid var(â€“div);background:var(â€“card);font-family:â€˜Nunitoâ€™,sans-serif;font-size:12.5px;font-weight:700;color:var(â€“mid);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:4px;transition:all .2s}
.tab.on{background:var(â€“pri);border-color:var(â€“pri);color:#fff}
.tab.done:not(.on){border-color:#4CAF50;color:var(â€“donec)}
.tcnt{font-size:10px;padding:1px 5px;border-radius:10px;background:var(â€“div);color:var(â€“soft)}
.tab.on .tcnt{background:rgba(255,255,255,.22);color:#fff}
.tab.done:not(.on) .tcnt{background:#E8F5E9;color:var(â€“donec)}

/* STEP CARDS */
.steps{padding:0 15px 16px}
.sublbl{font-size:10px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(â€“soft);margin-bottom:7px}
.sublbl.first{margin-top:4px}
.sublbl:not(.first){margin-top:18px}
.card{background:var(â€“card);border:1.5px solid transparent;border-radius:12px;padding:13px 14px;margin-bottom:7px;display:flex;gap:11px;align-items:flex-start;cursor:pointer;transition:background .2s,border-color .2s;box-shadow:0 1px 5px rgba(0,0,0,.07);-webkit-user-select:none;user-select:none}
.card.done{background:var(â€“donebg);border-color:var(â€“donebd)}
.card .ico{width:36px;height:36px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;background:var(â€“bg)}
.card.done .ico{background:var(â€“donec);font-size:18px}
.card .info{flex:1;min-width:0}
.card .ct{font-size:14px;font-weight:800;margin-bottom:2px;color:var(â€“txt)}
.card.done .ct{text-decoration:line-through;color:var(â€“soft)}
.card .cp{font-size:11.5px;font-weight:700;color:var(â€“acc);margin-bottom:4px}
.card.done .cp{color:#81C784}
.card .cd{font-size:12px;color:var(â€“mid);line-height:1.55}
.card.done .cd{color:#A5D6A7}
.empty-tab{text-align:center;padding:50px 20px;color:var(â€“soft)}
.empty-tab .ei{font-size:44px;margin-bottom:10px}

/* PAGE HEADERS */
.ph{padding:calc(env(safe-area-inset-top,0px)+12px) 15px 13px;display:flex;align-items:center;gap:10px;background:var(â€“bg);position:sticky;top:0;z-index:90;border-bottom:1.5px solid var(â€“div)}
.ph-title{font-family:â€˜Loraâ€™,serif;font-size:22px;font-weight:700;color:var(â€“pri);flex:1}
.pbody{padding:12px 15px 16px}

/* CARDS (settings/history) */
.sc{background:var(â€“card);border-radius:12px;padding:16px;margin-bottom:11px;box-shadow:0 1px 5px rgba(0,0,0,.07)}
.sl{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.6px;color:var(â€“soft);margin-bottom:9px;display:block}
.sdesc{font-size:12.5px;color:var(â€“mid);line-height:1.6;margin-bottom:11px}
.srow{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(â€“div)}
.srow:last-child{border-bottom:none}
.sk{font-size:13px;color:var(â€“mid)}
.sv{font-size:13px;font-weight:800;color:var(â€“txt)}
input[type=date]{width:100%;padding:11px 13px;border:1.5px solid var(â€“div);border-radius:10px;font-family:â€˜Nunitoâ€™,sans-serif;font-size:14px;color:var(â€“txt);background:var(â€“bg);outline:none;-webkit-appearance:none}
input[type=date]:focus{border-color:var(â€“pri)}
.stage-row{display:flex;gap:8px}
.stage-opt{flex:1;padding:13px 6px;border-radius:12px;text-align:center;cursor:pointer;border:1.5px solid var(â€“div);background:var(â€“bg);transition:all .2s}
.stage-opt.sel{border-color:var(â€“pri);background:#EAF4EB}
.stage-num{font-family:â€˜Loraâ€™,serif;font-size:24px;font-weight:700;color:var(â€“pri)}
.stage-lbl{font-size:10.5px;font-weight:700;color:var(â€“soft);margin-top:2px}
.alert-box{border-radius:12px;padding:14px;margin-bottom:11px;border:1.5px solid}
.alert-box.warn{background:#FFF3E0;border-color:#FF9800}
.alert-box.info{background:#E3F2FD;border-color:#64B5F6}
.alert-box .at{font-size:14px;font-weight:800;margin-bottom:5px}
.alert-box.warn .at{color:#E65100}
.alert-box.info .at{color:#1565C0}
.alert-box .ab{font-size:12.5px;line-height:1.55;color:#5D4037;margin-bottom:11px}
.btn{width:100%;padding:13px;border-radius:11px;font-family:â€˜Nunitoâ€™,sans-serif;font-size:14px;font-weight:800;border:none;background:var(â€“pri);color:#fff;cursor:pointer}

/* HISTORY */
.streak-card{border-radius:14px;padding:20px;margin-bottom:11px;text-align:center;background:linear-gradient(135deg,#E65100,#FF6D00);color:#fff}
.streak-num{font-family:â€˜Loraâ€™,serif;font-size:58px;font-weight:700;line-height:1}
.streak-lbl{font-size:13px;font-weight:700;margin-top:4px;opacity:.9}
.streak-sub{font-size:11.5px;margin-top:3px;opacity:.7}
.motiv-card{border-radius:14px;padding:17px 16px;margin-bottom:11px;background:linear-gradient(135deg,#1B5E20,#2E7D32);color:#fff;text-align:center}
.motiv-e{font-size:38px;margin-bottom:8px}
.motiv-t{font-size:14.5px;font-weight:800;line-height:1.4}
.motiv-s{font-size:12px;opacity:.75;margin-top:5px;line-height:1.5}
.wbar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.wbar-lbl{font-size:11.5px;color:var(â€“mid);width:30px;flex-shrink:0;text-align:right;font-weight:700}
.wbar-bg{flex:1;background:var(â€“div);border-radius:7px;height:16px;overflow:hidden;min-width:0}
.wbar-fill{height:100%;border-radius:7px;transition:width .6s;display:flex;align-items:center;justify-content:flex-end;padding-right:6px}
.wbar-pct{font-size:10.5px;font-weight:800;color:#fff}
.wbar-out{font-size:10.5px;font-weight:800;flex-shrink:0}
.hmap{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:10px}
.hday{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9.5px;font-weight:800;color:rgba(255,255,255,.9)}
.hday.empty-slot{background:transparent}
.hday.no-data{background:var(â€“div);color:var(â€“soft)}
.hday.perfect{background:#2E7D32}
.hday.good{background:#66BB6A}
.hday.partial{background:#FFB74D;color:#5D4037}
.hday.missed{background:#EF9A9A;color:#B71C1C}
.hday.today{box-shadow:0 0 0 2.5px var(â€“pri)}
.legend{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.leg-item{display:flex;align-items:center;gap:4px;font-size:11px;color:var(â€“mid)}
.leg-dot{width:11px;height:11px;border-radius:3px;flex-shrink:0}
.miss-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(â€“div);font-size:12.5px}
.miss-row:last-child{border-bottom:none}
.miss-name{flex:1;color:var(â€“mid)}
.miss-count{font-weight:800;color:#C62828;font-size:13px}
.achiev-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px}
.achiev-cell{background:var(â€“bg);border-radius:10px;padding:12px 10px;text-align:center}
.achiev-n{font-family:â€˜Loraâ€™,serif;font-size:26px;font-weight:700;color:var(â€“pri)}
.achiev-l{font-size:11px;color:var(â€“soft);font-weight:700;margin-top:2px}

/* RATING PILLS */
.rpill{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11.5px;font-weight:800}
.rpill.perfect{background:#E8F5E9;color:#2E7D32}
.rpill.good{background:#E3F2FD;color:#1565C0}
.rpill.partial{background:#FFF3E0;color:#E65100}
.rpill.missed{background:#FFEBEE;color:#C62828}

/* TOAST */
.toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%) translateY(12px);background:#1C2B1E;color:#fff;padding:9px 18px;border-radius:22px;font-size:13px;font-weight:700;opacity:0;transition:all .25s;z-index:999;pointer-events:none;white-space:nowrap}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
</style>

</head>
<body>

<!-- ROUTINE VIEW -->

<div id="vRoutine" class="view on">
  <div class="hdr">
    <div class="hdr-top">
      <span class="logo">ğŸŒ¿ My Routine</span>
      <button class="ib" onclick="switchView('Settings')">âš™ï¸</button>
    </div>
    <div id="banner" class="banner gym">
      <div class="brow1">
        <div>
          <div id="bDay" class="dayname">Loading...</div>
          <span id="bBadge" class="badge">...</span>
        </div>
        <button class="breset" onclick="resetDay()">â†º</button>
      </div>
      <div class="brow2">
        <span id="bStage" class="stagepill">Stage 1</span>
        <div class="pbar-wrap"><div id="bPFill" class="pbar-fill" style="width:0%"></div></div>
        <span id="bPLbl" class="pbar-lbl"></span>
      </div>
      <div class="brow3">
        <div class="dbar-wrap"><div id="bDFill" class="dbar-fill" style="width:0%"></div></div>
        <span id="bDLbl" class="dbar-lbl">0/0 done</span>
      </div>
    </div>
    <div class="tabs">
      <button id="tm" class="tab on" onclick="setTab('m')">ğŸŒ… Morning <span id="cm" class="tcnt">0/0</span></button>
      <button id="tw" class="tab"    onclick="setTab('w')">ğŸ•Œ Wudu <span id="cw" class="tcnt">0/0</span></button>
      <button id="te" class="tab"    onclick="setTab('e')">ğŸŒ† Evening <span id="ce" class="tcnt">0/0</span></button>
      <button id="tn" class="tab"    onclick="setTab('n')">ğŸŒ™ Night <span id="cn" class="tcnt">0/0</span></button>
    </div>
  </div>
  <div id="steps" class="steps"></div>
</div>

<!-- HISTORY VIEW -->

<div id="vHistory" class="view">
  <div class="ph">
    <span class="ph-title">ğŸ“Š History</span>
  </div>
  <div class="pbody" id="histBody"></div>
</div>

<!-- SETTINGS VIEW -->

<div id="vSettings" class="view">
  <div class="ph">
    <button class="ib" onclick="switchView('Routine')">â†</button>
    <span class="ph-title">Settings</span>
  </div>
  <div class="pbody">
    <div id="alertBox"></div>
    <div class="sc"><span class="sl">ğŸ“Š Progress</span><div id="statBox"></div></div>
    <div class="sc">
      <span class="sl">ğŸ“… Stage Start Date</span>
      <p class="sdesc">When did you start your current stage? This calculates your week number and stage upgrade alerts.</p>
      <input type="date" id="dateIn" onchange="saveDate(this.value)">
    </div>
    <div class="sc">
      <span class="sl">ğŸ¯ Current Stage</span>
      <p class="sdesc">Tap to switch stage. Start date resets automatically on upgrade.</p>
      <div class="stage-row" id="stageRow"></div>
    </div>
    <div class="sc">
      <span class="sl">â„¹ï¸ How to Use</span>
      <div id="howBox"></div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->

<div class="nav">
  <button class="nv on" id="nRoutine" onclick="switchView('Routine')"><span class="ni">ğŸ“‹</span>Routine</button>
  <button class="nv" id="nHistory" onclick="switchView('History')"><span class="ni">ğŸ“Š</span>History</button>
</div>

<div id="toast" class="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STORAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = 'myroutine_v3';
function loadState(){try{return JSON.parse(localStorage.getItem(SK))||{};}catch(e){return{};}}
function saveState(){try{localStorage.setItem(SK,JSON.stringify(ST));}catch(e){}}
function todayStr(){return new Date().toISOString().slice(0,10);}
function dayOfWeek(){return new Date().getDay();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ST = loadState();
if(!ST.stage)     ST.stage = 1;
if(!ST.startDate) ST.startDate = todayStr();
if(!ST.history)   ST.history = {};  // all-time record: {date:{done,total,gymDay,allIds,checkedIds}}
if(!ST.checks)    ST.checks = {};
if(!ST.bestStreak)ST.bestStreak = 0;

// Carry over yesterday to history before clearing today's checks
const td = todayStr();
if(ST.lastDay && ST.lastDay !== td && ST.lastDay && ST.curInfo){
  const prev = ST.lastDay;
  const ch = ST.checks[prev] || [];
  if(!ST.history[prev]){
    ST.history[prev] = {
      done: ch.length,
      total: ST.curInfo.total,
      gymDay: ST.curInfo.gymDay,
      allIds: ST.curInfo.allIds || [],
      checkedIds: ch
    };
  }
  delete ST.checks[prev];
}
ST.lastDay = td;
saveState();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONSTANTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const GYM=[1,3,5], OIL=[1,3];
const RATING_COLORS={perfect:'#2E7D32',good:'#1976D2',partial:'#E65100',missed:'#C62828',none:'#BDBDBD'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP BUILDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function S(id,ico,title,prod,det,sub){return{id,ico,title,prod,det,sub:sub||null};}

function elbowStep(stage,day){
  if(stage===1){
    const m={
      0:S('el','ğŸ’š','Niacinamide â†’ Body Oil','Niacinamide 10% + Body Oil','Press into dry elbows and knees. Seal with 2â€“3 drops body oil on top.'),
      1:S('el','ğŸ’›','Soronil Option A â†’ Niacinamide','Soronil 40% Urea + Niacinamide','BEFORE shower: apply Soronil, wait 15 min, rinse in shower. AFTER: Niacinamide + 2â€“3 drops body oil.'),
      2:S('el','ğŸ’š','Niacinamide â†’ Body Oil','Niacinamide 10% + Body Oil','Niacinamide on elbows/knees. Seal with body oil.'),
      3:S('el','ğŸ”†','Soronil Option B â€” Overnight','Soronil 40% Urea + Vaseline','After shower on DRY skin: generous Soronil â†’ thin Vaseline on top. No other active tonight.'),
      4:S('el','ğŸ’š','Niacinamide â†’ Body Oil','Niacinamide 10% + Body Oil','Niacinamide on elbows/knees. Seal with body oil.'),
      5:S('el','ğŸ’š','Niacinamide â†’ Body Oil','Niacinamide 10% + Body Oil','Niacinamide on elbows/knees. Seal with body oil.'),
      6:S('el','ğŸ’›','Soronil Option A (Sink Rinse)','Soronil 40% Urea + Niacinamide','No shower. Soronil 15 min, rinse at SINK. After: Niacinamide + body oil.'),
    };return m[day];
  }
  const m={
    0:S('el','ğŸŒ¿','Dermive â€” Rest Night','Jenpharm Dermive Sensitive','Rest night â€” no actives. Apply Dermive generously to elbows/knees.'),
    1:S('el','ğŸ”†','Soronil Option B Overnight','Soronil 40% Urea + Vaseline','After shower: Soronil â†’ Vaseline overnight. No other active.'),
    2:S('el','ğŸ’š','Niacinamide â†’ Body Oil','Niacinamide 10% + Body Oil','Niacinamide on elbows/knees. Seal with body oil.'),
    3:S('el','ğŸ’›','Soronil Option A â†’ Niacinamide','Soronil + Niacinamide','Before shower: Soronil 15 min, rinse. After: Niacinamide + body oil.'),
    4:S('el','ğŸ”µ','Azelaic Acid â†’ Body Oil','Azelaic Acid 10% + Body Oil','Press Azelaic Acid into dry elbows/knees. Seal with body oil.'),
    5:S('el','ğŸ’š','Niacinamide â†’ Body Oil','Niacinamide 10% + Body Oil','Niacinamide on elbows/knees. Seal.'),
    6:S('el','ğŸ’›','Soronil Option A â†’ Azelaic Acid','Soronil + Azelaic Acid 10%','No shower. Soronil 15 min, sink rinse. After: Azelaic Acid + body oil.'),
  };return m[day];
}

function feetStep(stage,day){
  if(stage===1)return S('ft','ğŸ¦¶','Foot Treatment â€” Soronil (Every Night)','Soronil 40% Urea + Vaseline + cotton sock','Soak prayer callus spots 5 min warm water. Pat dry. Soronil on spots only. Thin Vaseline. Cotton sock overnight.');
  if([5,6].includes(day))return S('ft','ğŸ’›','Foot Treatment â€” Soronil (Weekly)','Soronil + Vaseline + sock','Soak 5 min. Thin Soronil 10 min, rinse. Vaseline + sock overnight.');
  return S('ft','ğŸ¦¶','Foot Brightening',(day%2===0?'Niacinamide 10%':'Azelaic Acid 10%')+' + Vaseline + sock','Soak spots 5 min. Apply serum to callus areas. Vaseline on top. Cotton sock overnight.');
}

function buildRoutine(stage,day){
  const gym=GYM.includes(day),oil=OIL.includes(day);
  const M=[],W=[],E=[],N=[];
  const pfx=`s${stage}d${day}-`;

  // â”€â”€ MORNING â”€â”€
  if(gym){
    if(oil)M.push(S('hoil','ğŸ’†','Hair Oil','Hair Oil Blend â€” 1 ml','SCALP ONLY. Firm circular massage 3â€“5 min with fingertip pads. Leave on during gym (~2 hrs).','ğŸ‹ï¸ Before Gym'));
    M.push(S('itpre','ğŸ›¡ï¸','Inner Thigh Protection','Body Oil Blend â€” 2â€“3 drops','Thin layer on inner thigh friction zone before training.',oil?null:'ğŸ‹ï¸ Before Gym'));
    M.push(S('shamp','ğŸš¿',oil?'Shampoo â€” Double Wash':'Shampoo â€” Single Wash','Conatural Hair Growth Shampoo',oil?'1st lather: massage 60â€“90 sec. Rinse. 2nd lather: massage 2 min. Sit 60 sec. Cool rinse until completely clear.':'Massage 2 min. Sit 60 sec. Cool rinse until water runs clear.','ğŸš¿ Post-Shower'));
    M.push(S('cond','ğŸ’†','Conditioner','Conatural Rosemary Conditioner','STRANDS ONLY â€” never scalp. Squeeze from mid-shaft to tips. 60â€“90 sec. COOL rinse.'));
    M.push(S('mpep','ğŸŒ¿','Multi-Peptide Hair Serum','The Ordinary Multi-Peptide Serum','TOWEL-DRIED scalp (damp, not dripping). Apply drops to scalp only. Massage 30 sec. DO NOT RINSE â€” leave on all day.'));
    M.push(S('bwash','ğŸ§¼','Body Wash','Dove Sensitive Skin Body Wash','Lather in hands first. All over body. Rinse completely.'));
    M.push(S('boil','ğŸ«™','Body Oil','Body Oil Blend â€” 3â€“5 drops','Within 15 sec of drying while skin still slightly damp. Include belly â€” circular massage.'));
    M.push(S('deo','âœ¨','Deodorant','Phitkari (Alum Crystal)','Wet crystal under tap OR apply to damp underarm. Glide on skin. Leave to dry.'));
    M.push(S('cln','ğŸ§´','Cleanser','CeraVe Hydrating Cleanser â€” 1 pump','Circular motions 30â€“60 sec. COOL rinse. PAT dry.','ğŸ§´ Face & Eyes'));
    M.push(S('vitc','ğŸŠ','Vitamin C','The Ordinary Ascorbyl Glucoside 12% â€” 3â€“4 drops','âš ï¸ GYM DAYS ONLY. COMPLETELY DRY face. Press in sections. Wait 90 sec.'));
    M.push(S('ha','ğŸ’§','Hyaluronic Acid','The Ordinary HA 2% + B5 â€” 3â€“4 drops','SLIGHTLY DAMP face. Press gently. Wait 60 sec.'));
    M.push(S('caff','ğŸ‘ï¸','Caffeine Solution (Eyes)','The Ordinary Caffeine 5% + EGCG â€” 2â€“3 drops','RING FINGER ONLY. Orbital bone (5â€“6mm below lash line). Tap innerâ†’outer. Wait 60 sec.'));
    M.push(S('moist','ğŸ§´','Moisturiser','Neutrogena Hydro Boost â€” pea size','Dot 5 points. Press and blend upward.'));
    M.push(S('spf','â˜€ï¸','SPF','CeraVe Mineral SPF50 â€” Â¼ tsp','LAST face step. After wudu: only SPF washes off â€” reapply SPF only.','â˜€ï¸ SPF'));
    M.push(S('lip','ğŸ‘„','Lip Balm','DIY Lip Balm â€” thin layer','Before going outside. Reapply after every wudu.','ğŸ‘„ Finish'));
    M.push(S('hnd','ğŸ¤²','Hands','CeraVe IML or body oil â€” 2â€“3 drops','While hands still slightly damp from shower.'));
  } else {
    M.push(S('niac','ğŸ§´','Niacinamide','The Ordinary Niacinamide 10% + Zinc â€” 3â€“4 drops','No cleanser today â€” correct, not an error. Apply directly. Press in sections. Wait 90 sec.','ğŸ§´ Face & Eyes'));
    M.push(S('caff','ğŸ‘ï¸','Caffeine Solution (Eyes)','The Ordinary Caffeine 5% + EGCG â€” 2â€“3 drops','RING FINGER ONLY. After Niacinamide. Orbital bone. Tap innerâ†’outer. Wait 60 sec.'));
    M.push(S('moist','ğŸ§´','Moisturiser','Neutrogena Hydro Boost â€” pea size','Press and blend upward.'));
    M.push(S('spf','â˜€ï¸','SPF','CeraVe Mineral SPF50','LAST face step. Reapply after every wudu.','â˜€ï¸ SPF'));
    M.push(S('lip','ğŸ‘„','Lip Balm','DIY Lip Balm â€” thin layer','Before going outside. Reapply after wudu.','ğŸ‘„ Finish'));
    M.push(S('hnd','ğŸ¤²','Hands (if dry)','CeraVe IML or body oil','Apply when hands feel dry.'));
  }

  // â”€â”€ WUDU â”€â”€
  W.push(S('wspf','â˜€ï¸','Reapply SPF (if going outside)','CeraVe Mineral SPF50 â€” small amount','Wudu washes SPF off. Quick reapplication if going out. Serums underneath are absorbed â€” they do NOT wash off.','ğŸ•Œ After Wudu'));
  W.push(S('wlip','ğŸ‘„','Reapply Lip Balm','DIY Lip Balm','Thin layer after every wudu.'));

  // â”€â”€ EVENING â”€â”€
  const es=elbowStep(stage,day);
  E.push({...es,sub:'ğŸ¦µ Elbows & Knees'});
  if(!gym){
    const alt=[0,2,4,6].includes(day);
    E.push(stage===1
      ?S('it','ğŸ§´','Inner Thigh â€” Niacinamide','Niacinamide 10% + Body Oil','Flat inner thigh ONLY. Leave overnight. Seal with body oil.','ğŸ§´ Inner Thigh')
      :S('it','ğŸ§´','Inner Thigh â€” '+(alt?'Niacinamide':'Alpha Arbutin'),alt?'Niacinamide 10% + Body Oil':'Alpha Arbutin 2% + HA + Body Oil','Press onto flat inner thigh. Seal with body oil.','ğŸ§´ Inner Thigh'));
    if(stage>=2&&day===0)E.push(S('glyco','ğŸ”¬','Glycolic Acid â€” Inner Thigh (Weekly)','The Ordinary Glycolic Acid 7%','Cotton pad on flat inner thigh + groin crease. Hold 60 sec. Rinse off.','ğŸ”¬ Exfoliant'));
  }

  // â”€â”€ NIGHT â”€â”€
  if(stage>=2&&day===0){
    if(stage===2){
      N.push(S('sunw','ğŸ§´','Face Wash at Sink (Sunday)','CeraVe Hydrating Cleanser â€” Â½ pump','At sink only. 30 sec, cool rinse, pat dry.','ğŸ§´ Face'));
      N.push(S('clay','ğŸŸ¤','Clay Mask â€” T-Zone','Innisfree Volcanic Clay','Nose + forehead ONLY. 10 min. Mist if drying. Cool rinse.'));
      N.push(S('lact','ğŸ”¬','Lactic Acid 5%','The Ordinary Lactic Acid 5% + HA â€” 3â€“4 drops','DRY face. Avoid eye area. LEAVE ON â€” do not rinse.'));
      N.push(S('hm','ğŸ§´','Moisturiser','Neutrogena Hydro Boost','Seal Lactic Acid in.'));
    }else{
      N.push(S('sasa','ğŸ§´','SA Cleanser at Sink (Sunday)','CeraVe SA Cleanser','Lather 90 SECONDS at sink. Cool rinse. Replaces Lactic Acid.','ğŸ§´ Face'));
      N.push(S('clay','ğŸŸ¤','Clay Mask â€” T-Zone','Innisfree Volcanic Clay','T-zone only. 10 min. Cool rinse.'));
      N.push(S('hm','ğŸ§´','Moisturiser','Neutrogena Hydro Boost','Seal after SA cleanser and mask.'));
    }
  }else{
    N.push(S('niacn','ğŸ§´','Niacinamide','The Ordinary Niacinamide 10% + Zinc â€” 3â€“4 drops','Every single night â€” most important step.','ğŸ§´ Face'));
    N.push(S('hm','ğŸ§´','Moisturiser','Neutrogena Hydro Boost â€” pea size','Seal in. Slightly richer layer than daytime.'));
  }
  const ep=stage>=3
    ?{p:'CeraVe Vitamin C Eye Cream',d:'RING FINGER. Orbital bone. Tap innerâ†’outer. LAST face step. Stage 3 upgrade.'}
    :{p:'CeraVe Eye Repair Cream â€” grain-of-rice',d:'RING FINGER ONLY. Orbital bone only. Tap innerâ†’outer. ALWAYS the LAST face step.'};
  N.push(S('eye','ğŸ‘ï¸','Eye Cream (Night)',ep.p,ep.d,'ğŸ‘ï¸ Eyes'));
  N.push(S('belly','ğŸŒ€','Belly Massage','Body Oil / Rosehip Blend â€” 5â€“6 drops','Clockwise circles 3â€“5 min. MASSAGE matters as much as the oil.','ğŸŒ€ Belly'));
  const fs=feetStep(stage,day);
  N.push({...fs,sub:'ğŸ¦¶ Feet'});
  N.push(S('lipn','ğŸ‘„','Lip Balm â€” Bedtime','DIY Lip Balm â€” generous layer','Last thing before sleep. Extra thick on cracked areas.','ğŸ‘„ Lips'));
  N.push(S('teeth','ğŸ¦·','Brush Teeth','Sensodyne Pronamel Gentle Whitening','2 min. Spit. DO NOT RINSE â€” fluoride needs 30+ min on teeth.','ğŸ¦· Teeth'));

  const fix=arr=>arr.map(s=>({...s,id:pfx+s.id}));
  return{m:fix(M),w:fix(W),e:fix(E),n:fix(N)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function weekNum(){
  const diff=Math.floor((Date.now()-new Date(ST.startDate).getTime())/86400000);
  return Math.max(1,Math.floor(diff/7)+1);
}
function getChecked(){return ST.checks[td]||[];}
function todayRating(){
  if(!curRoutine)return'none';
  const all=[...curRoutine.m,...curRoutine.w,...curRoutine.e,...curRoutine.n];
  return getRating(getChecked().length,all.length);
}
function getRating(done,total){
  if(!total)return'none';
  const p=done/total;
  if(p>=1)return'perfect';
  if(p>=0.75)return'good';
  if(p>=0.4)return'partial';
  if(done>0)return'partial';
  return'missed';
}
function ratingColor(r){return RATING_COLORS[r]||RATING_COLORS.none;}
function ratingLabel(r){return{perfect:'â­ Perfect',good:'ğŸ‘ Good',partial:'âš ï¸ Partial',missed:'âŒ Missed',none:'â€”'}[r]||'â€”';}

let toastT;
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('on');
  clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('on'),2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ROUTINE RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let curTab='m', curRoutine=null;

function render(){
  const day=dayOfWeek(), gym=GYM.includes(day);
  curRoutine=buildRoutine(ST.stage,day);
  const all=[...curRoutine.m,...curRoutine.w,...curRoutine.e,...curRoutine.n];
  ST.curInfo={total:all.length,gymDay:gym,allIds:all.map(s=>s.id)};
  saveState();

  // Banner
  document.getElementById('banner').className='banner '+(gym?'gym':'rest');
  document.getElementById('bDay').textContent=DAYS[day];
  document.getElementById('bBadge').textContent=gym?'ğŸ‹ï¸ Gym Day':'ğŸ˜´ Rest Day';

  // Stage progress bar
  const wk=weekNum(), lim={1:12,2:8,3:999}[ST.stage];
  const stagePct=lim<999?Math.min(100,Math.round(wk/lim*100)):100;
  document.getElementById('bStage').textContent='Stage '+ST.stage;
  document.getElementById('bPFill').style.width=stagePct+'%';
  document.getElementById('bPLbl').textContent=lim<999?`Wk ${wk}/${lim}`:`Wk ${wk}`;

  updateTabs();
  renderSteps();
  updateDailyBar();
}

function updateTabs(){
  const ch=getChecked();
  [{k:'m',ti:'tm',ci:'cm'},{k:'w',ti:'tw',ci:'cw'},{k:'e',ti:'te',ci:'ce'},{k:'n',ti:'tn',ci:'cn'}].forEach(({k,ti,ci})=>{
    const steps=curRoutine[k]||[];
    const d=steps.filter(s=>ch.includes(s.id)).length;
    const allDone=steps.length>0&&d===steps.length;
    const btn=document.getElementById(ti);
    btn.className='tab'+(k===curTab?' on':allDone?' done':'');
    document.getElementById(ci).textContent=allDone?'âœ“':`${d}/${steps.length}`;
  });
}

function renderSteps(){
  const steps=curRoutine[curTab]||[];
  const ch=getChecked();
  const cont=document.getElementById('steps');
  if(!steps.length){
    cont.innerHTML='<div class="empty-tab"><div class="ei">ğŸ˜Œ</div><p style="font-size:13.5px;line-height:1.6">Nothing here today.<br>Rest day simplicity.</p></div>';
    return;
  }
  let html='',lastSub=null,isFirst=true;
  steps.forEach(s=>{
    if(s.sub&&s.sub!==lastSub){
      html+=`<div class="sublbl${isFirst?' first':''}">${s.sub}</div>`;
      lastSub=s.sub;isFirst=false;
    }
    const done=ch.includes(s.id);
    html+=`<div class="card${done?' done':''}" onclick="toggleStep('${s.id}')">
      <div class="ico">${done?'âœ…':s.ico}</div>
      <div class="info">
        <div class="ct">${s.title}</div>
        <div class="cp">${s.prod}</div>
        <div class="cd">${s.det}</div>
      </div>
    </div>`;
  });
  cont.innerHTML=html;
}

function updateDailyBar(){
  if(!curRoutine)return;
  const all=[...curRoutine.m,...curRoutine.w,...curRoutine.e,...curRoutine.n];
  const ch=getChecked();
  const d=ch.length, t=all.length;
  const pct=t?Math.round(d/t*100):0;
  document.getElementById('bDFill').style.width=pct+'%';
  document.getElementById('bDLbl').textContent=`${d}/${t} done`;
}

function toggleStep(id){
  if(!ST.checks[td])ST.checks[td]=[];
  const i=ST.checks[td].indexOf(id);
  i>=0?ST.checks[td].splice(i,1):ST.checks[td].push(id);
  saveState();
  updateTabs();
  // Update the clicked card only (avoid full re-render flicker)
  const ch=getChecked();
  const done=ch.includes(id);
  const card=document.querySelector(`.card[onclick="toggleStep('${id}')"]`);
  if(card){
    card.classList.toggle('done',done);
    const ico=card.querySelector('.ico');
    const step=[...curRoutine.m,...curRoutine.w,...curRoutine.e,...curRoutine.n].find(s=>s.id===id);
    if(ico&&step)ico.textContent=done?'âœ…':step.ico;
    const ct=card.querySelector('.ct');
    if(ct){ct.style.textDecoration=done?'line-through':'none';ct.style.color=done?'var(--soft)':'var(--txt)';}
  }
  updateDailyBar();
}

function resetDay(){
  ST.checks[td]=[];saveState();
  render();showToast('Today reset â†º');
}

function setTab(t){
  curTab=t;updateTabs();renderSteps();
  window.scrollTo({top:0,behavior:'smooth'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HISTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcStreak(){
  let streak=0;
  for(let i=0;i<730;i++){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    if(ds===td){
      // Today: only count if good/perfect
      const r=todayRating();
      if(r==='perfect'||r==='good'){streak++;continue;}
      else break;
    }
    const h=ST.history[ds];
    if(!h||h.total===0)break;
    const r=getRating(h.done,h.total);
    if(r==='perfect'||r==='good')streak++;
    else break;
  }
  return streak;
}

function getMotivMsg(streak,weekAvg){
  if(streak>=14)return{e:'ğŸ”¥',t:'You are UNSTOPPABLE!',s:`${streak} days straight. This kind of consistency actually changes skin.`};
  if(streak>=7) return{e:'ğŸ’ª',t:'Full week â€” real commitment',s:'7+ days in a row. You\'re building a genuine habit now.'};
  if(streak>=3) return{e:'ğŸŒ±',t:'3 days strong â€” keep going!',s:'The first 3 days are always the hardest. You\'ve passed them.'};
  if(streak>=1) return{e:'âœ¨',t:`Day ${streak} â€” great start!`,s:'Every expert was once a beginner. Keep showing up.'};
  if(weekAvg>=80)return{e:'ğŸ“ˆ',t:'Strong week overall',s:'Excellent weekly average. Missed yesterday? No problem â€” just restart.'};
  return{e:'ğŸ¤²',t:'Let\'s start fresh today',s:'Your skin doesn\'t judge missed days. Begin again â€” that\'s the only rule.'};
}

function renderHistory(){
  const hist=ST.history;
  const streak=calcStreak();
  if(streak>ST.bestStreak){ST.bestStreak=streak;saveState();}

  // Today's numbers
  let todayDone=0,todayTotal=0;
  if(curRoutine){
    const all=[...curRoutine.m,...curRoutine.w,...curRoutine.e,...curRoutine.n];
    todayTotal=all.length;todayDone=getChecked().length;
  }
  const todayR=todayTotal>0?getRating(todayDone,todayTotal):'none';

  // Weekly avg (last 7 days, excluding today)
  let wSum=0,wCnt=0;
  for(let i=1;i<=7;i++){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    const h=hist[ds];
    if(h&&h.total>0){wSum+=Math.round(h.done/h.total*100);wCnt++;}
  }
  const weekAvg=wCnt>0?Math.round(wSum/wCnt):0;
  const mv=getMotivMsg(streak,weekAvg);

  // All history keys sorted
  const allDays=Object.keys(hist).sort();
  const totalTracked=allDays.length+(todayTotal>0?1:0);
  const perfectDays=allDays.filter(ds=>{const h=hist[ds];return h&&getRating(h.done,h.total)==='perfect';}).length+(todayR==='perfect'?1:0);

  // 35-day heatmap
  const mapDays=[];
  for(let i=34;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);mapDays.push(d.toISOString().slice(0,10));}
  const firstDow=new Date(mapDays[0]).getDay();

  // Most missed (last 30 days)
  const missMap={};
  for(let i=1;i<=30;i++){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    const h=hist[ds];
    if(h&&h.allIds&&h.checkedIds){
      h.allIds.forEach(sid=>{
        if(!h.checkedIds.includes(sid)){
          const short=sid.split('-').pop();
          missMap[short]=(missMap[short]||0)+1;
        }
      });
    }
  }
  const topMissed=Object.entries(missMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const stepNames={hoil:'Hair Oil',itpre:'Inner Thigh Protection',shamp:'Shampoo',cond:'Conditioner',mpep:'Multi-Peptide Serum',bwash:'Body Wash',boil:'Body Oil',deo:'Deodorant',cln:'Cleanser',vitc:'Vitamin C',ha:'Hyaluronic Acid',caff:'Caffeine Solution',moist:'Moisturiser',spf:'SPF',lip:'Lip Balm (morning)',hnd:'Hand Care',niac:'Niacinamide (morning)',wspf:'SPF after Wudu',wlip:'Lip Balm after Wudu',el:'Elbows & Knees',it:'Inner Thigh',glyco:'Glycolic Acid',niacn:'Niacinamide (night)',hm:'Moisturiser (night)',eye:'Eye Cream',belly:'Belly Massage',ft:'Foot Treatment',lipn:'Lip Balm (night)',teeth:'Brush Teeth',sunw:'Sunday Face Wash',clay:'Clay Mask',lact:'Lactic Acid',sasa:'SA Cleanser'};

  let html='';

  // Streak
  html+=`<div class="streak-card">
    <div class="streak-num">${streak}</div>
    <div class="streak-lbl">ğŸ”¥ Day Streak</div>
    <div class="streak-sub">Consecutive days with good or perfect completion</div>
  </div>`;

  // Motivation
  html+=`<div class="motiv-card">
    <div class="motiv-e">${mv.e}</div>
    <div class="motiv-t">${mv.t}</div>
    <div class="motiv-s">${mv.s}</div>
  </div>`;

  // Today's status
  html+=`<div class="sc">
    <span class="sl">ğŸ“… Today â€” ${DAYS[dayOfWeek()]}</span>
    <div class="srow"><span class="sk">Steps Completed</span><span class="sv">${todayDone}/${todayTotal}</span></div>
    <div class="srow"><span class="sk">Completion %</span><span class="sv">${todayTotal?Math.round(todayDone/todayTotal*100):0}%</span></div>
    <div class="srow" style="border:none"><span class="sk">Rating</span><span class="sv">${todayR!=='none'?`<span class="rpill ${todayR}">${ratingLabel(todayR)}</span>`:'â€”'}</span></div>
  </div>`;

  // Last 7 day bars
  html+=`<div class="sc"><span class="sl">ğŸ“ˆ Last 7 Days</span>`;
  const DN=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    const dn=DN[d.getDay()];
    let pct=0,clr=RATING_COLORS.none;
    if(ds===td&&todayTotal>0){pct=Math.round(todayDone/todayTotal*100);clr=ratingColor(todayR);}
    else{const h=hist[ds];if(h&&h.total>0){pct=Math.round(h.done/h.total*100);clr=ratingColor(getRating(h.done,h.total));}}
    html+=`<div class="wbar-row">
      <span class="wbar-lbl">${dn}</span>
      <div class="wbar-bg"><div class="wbar-fill" style="width:${pct}%;background:${clr}">${pct>20?`<span class="wbar-pct">${pct}%</span>`:''}</div></div>
      ${pct>0&&pct<=20?`<span class="wbar-out" style="color:${clr}">${pct}%</span>`:'<span class="wbar-out" style="color:var(--div)">&nbsp;</span>'}
    </div>`;
  }
  html+=`<div style="font-size:11.5px;color:var(--soft);margin-top:8px;text-align:right">7-day avg: <b style="color:var(--txt);font-size:13px">${weekAvg}%</b></div></div>`;

  // 35-day heatmap
  html+=`<div class="sc">
    <span class="sl">ğŸ—“ï¸ 35-Day Heatmap</span>
    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
      ${['S','M','T','W','T','F','S'].map(l=>`<div style="flex:1;text-align:center;font-size:9.5px;font-weight:800;color:var(--soft)">${l}</div>`).join('')}
    </div>
    <div class="hmap">
      ${'<div class="hday empty-slot"></div>'.repeat(firstDow)}
      ${mapDays.map(ds=>{
        const d=new Date(ds);
        const dn=d.getDate();
        const isToday=ds===td;
        let cls='no-data';
        if(isToday&&todayTotal>0)cls=todayR;
        else{const h=hist[ds];if(h&&h.total>0)cls=getRating(h.done,h.total);}
        return`<div class="hday ${cls}${isToday?' today':''}">${dn}</div>`;
      }).join('')}
    </div>
    <div class="legend">
      ${[['perfect','â­ Perfect'],['good','ğŸ‘ Good'],['partial','âš ï¸ Partial'],['missed','âŒ Missed'],['no-data','No data']].map(([c,l])=>`<div class="leg-item"><div class="leg-dot" style="background:${c==='no-data'?'var(--div)':RATING_COLORS[c]}"></div>${l}</div>`).join('')}
    </div>
  </div>`;

  // Most skipped
  if(topMissed.length>0){
    html+=`<div class="sc"><span class="sl">âš ï¸ Most Skipped (Last 30 Days)</span>`;
    topMissed.forEach(([id,cnt])=>{
      html+=`<div class="miss-row"><span style="font-size:16px">â—</span><span class="miss-name">${stepNames[id]||id}</span><span class="miss-count">${cnt}Ã— skipped</span></div>`;
    });
    html+=`</div>`;
  }

  // Achievements
  html+=`<div class="sc">
    <span class="sl">ğŸ† All-Time Achievements</span>
    <div class="achiev-grid">
      <div class="achiev-cell"><div class="achiev-n">${totalTracked}</div><div class="achiev-l">Days Tracked</div></div>
      <div class="achiev-cell"><div class="achiev-n">${perfectDays}â­</div><div class="achiev-l">Perfect Days</div></div>
      <div class="achiev-cell"><div class="achiev-n">${streak}ğŸ”¥</div><div class="achiev-l">Current Streak</div></div>
      <div class="achiev-cell"><div class="achiev-n">${ST.bestStreak}</div><div class="achiev-l">Best Streak Ever</div></div>
    </div>
  </div>`;

  // All-time daily log (last 14 days)
  const recent=Object.keys(hist).sort().reverse().slice(0,14);
  if(recent.length>0){
    html+=`<div class="sc"><span class="sl">ğŸ“… Recent Daily Log</span>`;
    recent.forEach(ds=>{
      const h=hist[ds];
      const r=getRating(h.done,h.total);
      const d=new Date(ds);
      const label=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
      html+=`<div class="srow"><span class="sk" style="font-size:12px">${label}</span><span class="sv" style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--soft)">${h.done}/${h.total}</span><span class="rpill ${r}" style="font-size:10px;padding:2px 7px">${ratingLabel(r)}</span></span></div>`;
    });
    html+=`</div>`;
  }

  document.getElementById('histBody').innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  const wk=weekNum(),lim={1:12,2:8,3:999}[ST.stage];
  const pct=lim<999?Math.min(100,Math.round(wk/lim*100)):100;
  const days=Math.max(0,Math.floor((Date.now()-new Date(ST.startDate).getTime())/86400000));
  document.getElementById('dateIn').value=ST.startDate;

  document.getElementById('statBox').innerHTML=[
    ['Current Stage',`Stage ${ST.stage}`],
    ['Started',new Date(ST.startDate).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})],
    ['Days in Stage',`${days} days`],
    ['Current Week',`Week ${wk}`],
    ['Stage Progress',lim<999?`${pct}% of ${lim} weeks`:'Maintenance â€” no limit'],
  ].map(([k,v])=>`<div class="srow"><span class="sk">${k}</span><span class="sv">${v}</span></div>`).join('');

  document.getElementById('stageRow').innerHTML=[1,2,3].map(n=>`
    <div class="stage-opt${ST.stage===n?' sel':''}" onclick="changeStage(${n})">
      <div class="stage-num">${n}</div>
      <div class="stage-lbl">${['Foundation','Exfoliants','Maintenance'][n-1]}</div>
    </div>`).join('');

  const ab=document.getElementById('alertBox');
  if(ST.stage===1&&wk>=12){
    ab.innerHTML=`<div class="alert-box warn"><div class="at">âš¡ Ready for Stage 2!</div><p class="ab">Week ${wk} of Stage 1 complete. If your skin is calm and barrier is stable â€” you're ready to upgrade!</p><button class="btn" onclick="changeStage(2);switchView('Routine')">Move to Stage 2 â†’</button></div>`;
  }else if(ST.stage===1&&wk>=8){
    ab.innerHTML=`<div class="alert-box info"><div class="at">ğŸ’¡ Stage 2 Coming Soon</div><p class="ab" style="margin-bottom:0">Week ${wk}. Stage 2 available now if barrier is stable, or safely at Week 12.</p></div>`;
  }else ab.innerHTML='';

  document.getElementById('howBox').innerHTML=[
    'Open every morning â€” shows today\'s routine automatically (Gym or Rest day)',
    'Tap any step card to mark it âœ… Done â€” it turns green',
    'Work through all 4 tabs: Morning â†’ After Wudu â†’ Evening â†’ Night',
    'Checks reset automatically at midnight for the new day',
    'Tap â†º button to reset today\'s ticks manually',
    'History tab saves ALL TIME â€” streak, heatmap, perfect days, most skipped',
    'App alerts at Week 8 and Week 12 when it\'s time to upgrade stage',
    'âš ï¸ Must use NORMAL Safari (not Private Browsing) for saving to work',
  ].map((t,i)=>`<div style="display:flex;gap:8px;margin-bottom:9px;align-items:flex-start"><span style="font-weight:800;color:var(--pri);font-size:13px;flex-shrink:0;margin-top:1px">${i+1}.</span><span style="font-size:12.5px;color:var(--mid);line-height:1.5">${t}</span></div>`).join('');
}

function saveDate(v){ST.startDate=v;saveState();renderSettings();showToast('Start date saved âœ“');}
function changeStage(n){
  ST.stage=n;ST.startDate=todayStr();ST.checks={};saveState();
  renderSettings();render();
  showToast(n>1?`ğŸ‰ Moved to Stage ${n}!`:`Set to Stage ${n}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEW SWITCHING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(v){
  ['Routine','History','Settings'].forEach(name=>{
    document.getElementById('v'+name).classList.toggle('on',name===v);
  });
  document.getElementById('nRoutine').classList.toggle('on',v==='Routine');
  document.getElementById('nHistory').classList.toggle('on',v==='History');
  window.scrollTo({top:0,behavior:'instant'});
  if(v==='History'){renderHistory();}
  if(v==='Settings'){renderSettings();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
</script>

</body>
</html>
